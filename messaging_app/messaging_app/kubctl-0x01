#!/bin/bash

# Script: kubctl-0x01
# Purpose: Scale Django app deployment, verify pods, load test with wrk, and monitor resource usage

DEPLOYMENT_NAME="django-messaging-app"

echo "Scaling deployment '$DEPLOYMENT_NAME' to 3 replicas..."
kubectl scale deployment "$DEPLOYMENT_NAME" --replicas=3

echo "Waiting for pods to be ready..."
sleep 10  # Adjust based on startup time

echo "Verifying running pods..."
kubectl get pods -l app=messaging

echo "Performing load test using wrk..."
# url is node ip and nodeport
APP_URL="http://192.168.49.2:31234"

# Run wrk for 30 seconds with 12 threads and 400 connections
wrk -t12 -c400 -d30s "$APP_URL"

echo "Monitoring resource usage..."
kubectl top pods
